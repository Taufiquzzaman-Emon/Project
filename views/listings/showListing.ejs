<% layout("/layouts/boilerplate") %>

<div class="listing-detail-page">
  <div class="container mt-5">
    <!-- Enhanced Listing Header -->
    <div class="listing-header-section">
      <div class="row mb-5">
        <div class="col-lg-10 offset-lg-1">
          <div class="header-card text-center">
            <div class="location-badge mb-3">
              <i class="fas fa-map-marker-alt me-2"></i>
              <%= listing.location %>, <%= listing.country %>
            </div>
            <h1 class="listing-main-title gradient-text fw-bold mb-3">
              <%= listing.title %>
            </h1>
            <div class="header-meta">
              <div class="meta-item">
                <i class="fas fa-user-circle me-2"></i>
                <span
                  >Hosted by
                  <strong><%= listing.owner.username %></strong></span
                >
              </div>
              <div class="meta-divider"></div>
              <div class="meta-item">
                <i class="fas fa-calendar-plus me-2"></i>
                <span>Available now</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Image Section -->
    <div class="image-section mb-5">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="image-container">
            <img
              src="<%= listing.image.url %>"
              class="listing-main-image"
              alt="<%= listing.title %>"
            />
            <div class="image-gradient-overlay"></div>
            <div class="image-actions">
              <button
                class="image-action-btn favorite-btn"
                onclick="toggleFavorite(this)"
              >
                <i class="far fa-heart"></i>
              </button>
              <button
                class="image-action-btn share-btn"
                onclick="shareListing()"
              >
                <i class="fas fa-share-alt"></i>
              </button>
              <button
                class="image-action-btn fullscreen-btn"
                onclick="viewFullscreen()"
              >
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Details Section -->
    <div class="details-section">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="details-grid">
            <!-- Main Info Card -->
            <div class="info-card main-info">
              <div class="card-header">
                <h3 class="card-title">About this place</h3>
              </div>
              <div class="card-content">
                <p class="description"><%= listing.description %></p>
                <div class="amenities-preview">
                  <div class="amenity-item">
                    <i class="fas fa-wifi"></i>
                    <span>Free WiFi</span>
                  </div>
                  <div class="amenity-item">
                    <i class="fas fa-parking"></i>
                    <span>Free parking</span>
                  </div>
                  <div class="amenity-item">
                    <i class="fas fa-swimming-pool"></i>
                    <span>Pool access</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pricing Card -->
            <div class="info-card pricing-card">
              <div class="price-header">
                <div class="price-display">
                  <span class="price-amount">$<%= listing.price %></span>
                  <span class="price-period">per night</span>
                </div>
                <div class="rating-display">
                  <i class="fas fa-star"></i>
                  <span>New listing</span>
                </div>
              </div>

              <!-- Owner Controls -->
              <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
              <div class="owner-controls">
                <div class="control-header">
                  <i class="fas fa-cog me-2"></i>
                  <span>Manage Listing</span>
                </div>
                <div class="control-actions">
                  <a
                    href="/listings/<%= listing._id %>/edit"
                    class="btn control-btn edit-btn"
                  >
                    <i class="fas fa-edit me-2"></i>Edit Listing
                  </a>
                  <form
                    method="POST"
                    action="/listings/<%= listing._id %>?_method=DELETE"
                    class="delete-form"
                  >
                    <button
                      type="button"
                      class="btn control-btn delete-btn"
                      onclick="confirmDelete(this)"
                    >
                      <i class="fas fa-trash me-2"></i>Delete Listing
                    </button>
                  </form>
                </div>
              </div>
              <% } else if (currUser) { %>

              <!-- Reserve Section -->
              <div class="reserve-section">
                <button
                  class="btn reserve-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#reserveModal"
                >
                  <span class="btn-content">
                    <i class="fas fa-calendar-check me-2"></i>Reserve Now
                  </span>
                  <div class="btn-glow"></div>
                </button>
                <div class="reserve-note">
                  <i class="fas fa-shield-alt me-2"></i>
                  <span>Free cancellation for 48 hours</span>
                </div>
              </div>
              <% } else { %>

              <!-- Login Prompt -->
              <div class="login-prompt">
                <p class="prompt-text">Sign in to make a reservation</p>
                <a href="/login" class="btn login-btn">
                  <i class="fas fa-sign-in-alt me-2"></i>Sign In
                </a>
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Reserve Modal -->
    <div
      class="modal fade"
      id="reserveModal"
      tabindex="-1"
      aria-labelledby="reserveModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content enhanced-modal">
          <form action="/listings/<%= listing._id %>/reserve" method="POST">
            <div class="modal-header">
              <div class="modal-title-section">
                <h4 class="modal-title" id="reserveModalLabel">
                  <i class="fas fa-calendar-check me-2"></i>
                  Reserve Your Stay
                </h4>
                <p class="modal-subtitle">
                  Complete your booking for <%= listing.title %>
                </p>
              </div>
              <button
                type="button"
                class="btn-close-custom"
                data-bs-dismiss="modal"
                aria-label="Close"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="modal-body">
              <div class="booking-form">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-calendar-plus me-2"></i>Check-in
                    </label>
                    <input
                      type="date"
                      class="form-control enhanced-input"
                      id="checkin"
                      name="checkin"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-calendar-minus me-2"></i>Check-out
                    </label>
                    <input
                      type="date"
                      class="form-control enhanced-input"
                      id="checkout"
                      name="checkout"
                      required
                    />
                  </div>
                </div>

                <div class="booking-summary">
                  <div class="summary-row">
                    <span>Price per night</span>
                    <span>$<%= listing.price %></span>
                  </div>
                  <div class="summary-row total">
                    <span>Total</span>
                    <span id="total-price">$<%= listing.price %></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn cancel-btn"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="submit" class="btn confirm-btn">
                <span class="btn-content">
                  <i class="fas fa-check me-2"></i>Confirm Reservation
                </span>
                <span class="btn-loader">
                  <i class="fas fa-spinner fa-spin"></i>
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Enhanced Reviews Section -->
    <div class="reviews-section">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <!-- Leave Review Card (if logged in) -->
          <% if (currUser) { %>
          <div class="review-form-card mb-5">
            <div class="card-header">
              <h4 class="section-title">
                <i class="fas fa-star me-2"></i>Share Your Experience
              </h4>
              <p class="section-subtitle">
                Help others discover this amazing place
              </p>
            </div>

            <form
              action="/listings/<%= listing._id %>/reviews"
              method="POST"
              class="review-form"
            >
              <div class="rating-section mb-4">
                <label class="form-label">Rating</label>
                <div class="star-rating">
                  <input
                    type="radio"
                    id="star5"
                    name="review[rating]"
                    value="5"
                  />
                  <label for="star5" class="star"
                    ><i class="fas fa-star"></i
                  ></label>
                  <input
                    type="radio"
                    id="star4"
                    name="review[rating]"
                    value="4"
                  />
                  <label for="star4" class="star"
                    ><i class="fas fa-star"></i
                  ></label>
                  <input
                    type="radio"
                    id="star3"
                    name="review[rating]"
                    value="3"
                  />
                  <label for="star3" class="star"
                    ><i class="fas fa-star"></i
                  ></label>
                  <input
                    type="radio"
                    id="star2"
                    name="review[rating]"
                    value="2"
                  />
                  <label for="star2" class="star"
                    ><i class="fas fa-star"></i
                  ></label>
                  <input
                    type="radio"
                    id="star1"
                    name="review[rating]"
                    value="1"
                  />
                  <label for="star1" class="star"
                    ><i class="fas fa-star"></i
                  ></label>
                </div>
              </div>

              <div class="comment-section mb-4">
                <label class="form-label">Your Review</label>
                <textarea
                  name="review[comment]"
                  class="form-control enhanced-textarea"
                  rows="4"
                  placeholder="Share your thoughts about this place..."
                  required
                ></textarea>
              </div>

              <button type="submit" class="btn submit-review-btn">
                <span class="btn-content">
                  <i class="fas fa-paper-plane me-2"></i>Submit Review
                </span>
                <span class="btn-loader">
                  <i class="fas fa-spinner fa-spin"></i>
                </span>
              </button>
            </form>
          </div>
          <% } %>

          <!-- Existing Reviews -->
          <% if (listing.reviews.length > 0) { %>
          <div class="reviews-display">
            <div class="reviews-header mb-4">
              <h4 class="section-title">
                <i class="fas fa-comments me-2"></i>Guest Reviews
              </h4>
              <div class="reviews-stats">
                <span class="review-count">
                  <%= listing.reviews.length %> <%= listing.reviews.length === 1
                  ? 'review' : 'reviews' %>
                </span>
              </div>
            </div>

            <div class="reviews-grid">
              <% listing.reviews.forEach(function(review, index) { %>
              <div
                class="review-card"
                style="animation-delay: <%= index * 100 %>ms"
              >
                <div class="review-header">
                  <div class="reviewer-info">
                    <div class="reviewer-avatar">
                      <%= review.author.username.charAt(0).toUpperCase() %>
                    </div>
                    <div class="reviewer-details">
                      <h6 class="reviewer-name">
                        @<%= review.author.username %>
                      </h6>
                      <small class="review-date">
                        <%= new
                        Date(review.createdAt).toLocaleDateString('en-US', {
                        month: 'long', day: 'numeric', year: 'numeric' }) %>
                      </small>
                    </div>
                  </div>

                  <div class="review-rating">
                    <% for(let i = 1; i <= 5; i++) { %>
                    <i
                      class="<%= i <= review.rating ? 'fas' : 'far' %> fa-star"
                    ></i>
                    <% } %>
                  </div>
                </div>

                <div class="review-content">
                  <p class="review-comment"><%= review.comment %></p>
                </div>

                <% if(currUser && review.author._id.equals(currUser._id)) { %>
                <div class="review-actions">
                  <form
                    method="POST"
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                  >
                    <button
                      type="button"
                      class="btn delete-review-btn"
                      onclick="confirmReviewDelete(this)"
                    >
                      <i class="fas fa-trash me-2"></i>Delete
                    </button>
                  </form>
                </div>
                <% } %>
              </div>
              <% }); %>
            </div>
          </div>
          <% } else { %>
          <div class="no-reviews-state">
            <div class="no-reviews-icon">
              <i class="fas fa-comment-slash"></i>
            </div>
            <h5 class="fw-bold mb-2">No reviews yet</h5>
            <p class="text-muted">Be the first to share your experience!</p>
          </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Enhanced Map Section -->
    <div class="map-section">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="map-card">
            <div class="map-header">
              <h4 class="section-title">
                <i class="fas fa-map-marked-alt me-2"></i>Location
              </h4>
              <p class="section-subtitle">Explore the neighborhood</p>
            </div>
            <div class="map-container">
              <div id="map" class="enhanced-map"></div>
              <div class="map-overlay">
                <div class="location-info">
                  <i class="fas fa-map-marker-alt me-2"></i>
                  <%= listing.location %>, <%= listing.country %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Styles -->
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    --warning-gradient: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
    --price-gradient: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  /* Page Background */
  .listing-detail-page {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    position: relative;
  }

  .listing-detail-page::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        circle at 25% 25%,
        rgba(102, 126, 234, 0.08) 0%,
        transparent 50%
      ),
      radial-gradient(
        circle at 75% 75%,
        rgba(118, 75, 162, 0.08) 0%,
        transparent 50%
      );
    pointer-events: none;
    z-index: -1;
  }

  /* Header Section */
  .listing-header-section {
    padding: 2rem 0;
  }

  .header-card {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
    animation: slideInDown 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .header-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(102, 126, 234, 0.1),
      transparent
    );
    transition: left 0.8s ease;
  }

  .header-card:hover::before {
    left: 100%;
  }

  .location-badge {
    display: inline-block;
    background: var(--primary-gradient);
    color: white;
    padding: 0.5rem 1.25rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    animation: badgeFloat 4s ease-in-out infinite;
  }

  .listing-main-title {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 3rem;
    line-height: 1.2;
  }

  .header-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: #64748b;
    font-weight: 500;
  }

  .meta-item {
    display: flex;
    align-items: center;
  }

  .meta-divider {
    width: 1px;
    height: 20px;
    background: #cbd5e0;
  }

  /* Image Section */
  .image-section {
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
  }

  .image-container {
    position: relative;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .image-container:hover {
    transform: scale(1.02);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
  }

  .listing-main-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .image-container:hover .listing-main-image {
    transform: scale(1.1);
  }

  .image-gradient-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.3) 0%,
      transparent 50%,
      rgba(0, 0, 0, 0.2) 100%
    );
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .image-container:hover .image-gradient-overlay {
    opacity: 1;
  }

  .image-actions {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .image-container:hover .image-actions {
    opacity: 1;
    transform: translateX(0);
  }

  .image-action-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 50%;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-md);
  }

  .image-action-btn:hover {
    background: var(--primary-gradient);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  /* Details Section */
  .details-section {
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s both;
  }

  .details-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  .info-card {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .info-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  .card-header {
    padding: 2rem 2rem 1rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
  }

  .card-title {
    color: #1e293b;
    font-weight: 700;
    margin-bottom: 0;
  }

  .card-content {
    padding: 1.5rem 2rem 2rem;
  }

  .description {
    color: #64748b;
    line-height: 1.6;
    font-size: 1rem;
    margin-bottom: 1.5rem;
  }

  .amenities-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .amenity-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .amenity-item i {
    color: var(--primary-gradient);
    width: 16px;
  }

  /* Pricing Card */
  .pricing-card {
    position: sticky;
    top: 100px;
    height: fit-content;
  }

  .price-header {
    padding: 2rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .price-display {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .price-amount {
    font-size: 2rem;
    font-weight: 700;
    background: var(--price-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .price-period {
    color: #64748b;
    font-weight: 500;
  }

  .rating-display {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: #fbbf24;
    font-weight: 600;
    font-size: 0.9rem;
  }

  /* Owner Controls */
  .owner-controls {
    padding: 2rem;
  }

  .control-header {
    display: flex;
    align-items: center;
    color: #64748b;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .control-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .control-btn {
    padding: 0.875rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .edit-btn {
    background: var(--success-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
  }

  .edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
  }

  .delete-btn {
    background: var(--danger-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
  }

  .delete-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 65, 108, 0.5);
  }

  /* Reserve Section */
  .reserve-section {
    padding: 2rem;
  }

  .reserve-btn {
    width: 100%;
    background: var(--price-gradient);
    border: none;
    border-radius: 16px;
    padding: 1rem 2rem;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .btn-close-custom {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .btn-close-custom:hover {
    background: var(--danger-gradient);
    color: white;
    transform: scale(1.1);
  }

  /* Form Enhancements */
  .booking-form {
    padding: 1rem 0;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-label {
    color: #374151;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .enhanced-input {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
  }

  .enhanced-input:focus {
    border-color: var(--primary-gradient);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
  }

  .booking-summary {
    background: rgba(248, 250, 252, 0.8);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    color: #64748b;
  }

  .summary-row.total {
    border-top: 2px solid #e5e7eb;
    margin-top: 0.5rem;
    padding-top: 1rem;
    font-weight: 700;
    color: #1e293b;
    font-size: 1.1rem;
  }

  /* Modal Footer Buttons */
  .cancel-btn {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .cancel-btn:hover {
    background: rgba(107, 114, 128, 0.2);
    border-color: #d1d5db;
  }

  .confirm-btn {
    background: var(--success-gradient);
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .confirm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
  }

  /* Reviews Section */
  .reviews-section {
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.6s both;
    margin-top: 3rem;
  }

  .review-form-card {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    transition: all 0.4s ease;
  }

  .review-form-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
  }

  .section-title {
    color: #1e293b;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .section-subtitle {
    color: #64748b;
    margin-bottom: 0;
  }

  /* Star Rating */
  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 0.25rem;
  }

  .star-rating input {
    display: none;
  }

  .star-rating .star {
    cursor: pointer;
    font-size: 1.5rem;
    color: #d1d5db;
    transition: all 0.3s ease;
    padding: 0.25rem;
    border-radius: 4px;
  }

  .star-rating .star:hover,
  .star-rating .star:hover ~ .star,
  .star-rating input:checked ~ .star {
    color: #fbbf24;
    transform: scale(1.1);
  }

  .star-rating .star:hover {
    transform: scale(1.2);
  }

  /* Enhanced Textarea */
  .enhanced-textarea {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
    resize: vertical;
    min-height: 120px;
  }

  .enhanced-textarea:focus {
    border-color: var(--primary-gradient);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
  }

  .submit-review-btn {
    background: var(--primary-gradient);
    border: none;
    border-radius: 12px;
    padding: 0.875rem 2rem;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .submit-review-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }

  /* Reviews Display */
  .reviews-display {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: var(--shadow-lg);
  }

  .reviews-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .review-count {
    background: var(--primary-gradient);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .reviews-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .review-card {
    background: rgba(248, 250, 252, 0.8);
    border: 1px solid rgba(226, 232, 240, 0.8);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
  }

  .review-card:hover {
    transform: translateX(8px);
    box-shadow: var(--shadow-md);
    background: rgba(241, 245, 249, 1);
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .reviewer-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .reviewer-avatar {
    width: 45px;
    height: 45px;
    background: var(--primary-gradient);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .reviewer-name {
    color: #1e293b;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .review-date {
    color: #64748b;
    font-weight: 500;
  }

  .review-rating {
    display: flex;
    gap: 0.25rem;
    color: #fbbf24;
    font-size: 1rem;
  }

  .review-comment {
    color: #374151;
    line-height: 1.6;
    margin-bottom: 0;
  }

  .review-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(226, 232, 240, 0.8);
  }

  .delete-review-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .delete-review-btn:hover {
    background: var(--danger-gradient);
    color: white;
    border-color: transparent;
  }

  /* No Reviews State */
  .no-reviews-state {
    text-align: center;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--glass-border);
  }

  .no-reviews-icon {
    font-size: 3rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
  }

  /* Map Section */
  .map-section {
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.8s both;
    margin-top: 3rem;
  }

  .map-card {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }

  .map-header {
    padding: 2rem 2rem 1rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
  }

  .map-container {
    position: relative;
    padding: 2rem;
  }

  .enhanced-map {
    width: 100%;
    height: 400px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-md);
  }

  .map-overlay {
    position: absolute;
    bottom: 3rem;
    left: 3rem;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    font-weight: 600;
  }

  /* Animations */
  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes badgeFloat {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }

  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  /* Loading States */
  .btn-content {
    transition: opacity 0.3s ease;
  }

  .btn-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .btn.loading .btn-content {
    opacity: 0;
  }

  .btn.loading .btn-loader {
    opacity: 1;
  }

  /* Responsive Design */
  @media (max-width: 992px) {
    .details-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .pricing-card {
      position: static;
    }

    .listing-main-title {
      font-size: 2.5rem;
    }
  }

  @media (max-width: 768px) {
    .header-card {
      padding: 2rem 1.5rem;
    }

    .listing-main-title {
      font-size: 2rem;
    }

    .header-meta {
      flex-direction: column;
      gap: 0.5rem;
    }

    .meta-divider {
      display: none;
    }

    .listing-main-image {
      height: 300px;
    }

    .form-row {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .image-actions {
      flex-direction: row;
      top: auto;
      bottom: 1.5rem;
      right: 1.5rem;
    }
  }

  @media (max-width: 576px) {
    .header-card {
      padding: 1.5rem 1rem;
    }

    .listing-main-title {
      font-size: 1.75rem;
    }

    .card-header,
    .card-content {
      padding: 1.5rem;
    }

    .map-overlay {
      bottom: 2rem;
      left: 2rem;
      right: 2rem;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
    }
  }

  /* Additional Interaction States */
  .form-control:invalid {
    border-color: #ef4444;
  }

  .form-control:valid {
    border-color: #10b981;
  }

  /* Smooth transitions for all interactive elements */
  * {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
</style>

<!-- Enhanced JavaScript -->
<script>
  // Pass server data to client
  window.listingCoordinates = <%= listing.geometry && listing.geometry.coordinates ? JSON.stringify(listing.geometry.coordinates) : '[]' %>;
  window.listingLocation = "<%= listing.location %>";
  window.maptilerApiKey = "<%= maptilerApiKey %>";
  window.listingPrice = <%= listing.price %>;
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    initializeEnhancements();
    setupDateValidation();
    setupPriceCalculation();
  });

  function initializeEnhancements() {
    // Add scroll animations
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = "1";
          entry.target.style.transform = "translateY(0)";
        }
      });
    });

    document.querySelectorAll(".info-card, .review-card").forEach((el) => {
      observer.observe(el);
    });

    // Enhanced form interactions
    const inputs = document.querySelectorAll(
      ".enhanced-input, .enhanced-textarea"
    );
    inputs.forEach((input) => {
      input.addEventListener("focus", function () {
        this.parentElement.classList.add("focused");
      });

      input.addEventListener("blur", function () {
        this.parentElement.classList.remove("focused");
      });
    });

    // Modal enhancements
    const modal = document.getElementById("reserveModal");
    if (modal) {
      modal.addEventListener("show.bs.modal", function () {
        this.style.animation = "fadeInScale 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
      });
    }
  }

  function setupDateValidation() {
    const checkinInput = document.getElementById("checkin");
    const checkoutInput = document.getElementById("checkout");

    if (checkinInput && checkoutInput) {
      // Set minimum date to today
      const today = new Date().toISOString().split("T")[0];
      checkinInput.min = today;

      checkinInput.addEventListener("change", function () {
        const checkinDate = new Date(this.value);
        const minCheckout = new Date(checkinDate);
        minCheckout.setDate(minCheckout.getDate() + 1);
        checkoutInput.min = minCheckout.toISOString().split("T")[0];

        if (
          checkoutInput.value &&
          new Date(checkoutInput.value) <= checkinDate
        ) {
          checkoutInput.value = "";
        }

        updatePriceCalculation();
      });

      checkoutInput.addEventListener("change", updatePriceCalculation);
    }
  }

  function setupPriceCalculation() {
    const totalPriceElement = document.getElementById("total-price");

    function updatePriceCalculation() {
      const checkin = document.getElementById("checkin").value;
      const checkout = document.getElementById("checkout").value;

      if (checkin && checkout) {
        const checkinDate = new Date(checkin);
        const checkoutDate = new Date(checkout);
        const nights = Math.ceil(
          (checkoutDate - checkinDate) / (1000 * 60 * 60 * 24)
        );

        if (nights > 0) {
          const total = nights * window.listingPrice;
          totalPriceElement.textContent = `${total} (${nights} ${
            nights === 1 ? "night" : "nights"
          })`;
        }
      }
    }

    window.updatePriceCalculation = updatePriceCalculation;
  }

  function toggleFavorite(button) {
    const icon = button.querySelector("i");
    const isActive = button.classList.contains("active");

    if (isActive) {
      button.classList.remove("active");
      icon.className = "far fa-heart";
      showNotification("Removed from favorites", "info");
    } else {
      button.classList.add("active");
      icon.className = "fas fa-heart";
      showNotification("Added to favorites!", "success");

      button.style.animation = "pulse 0.6s ease-out";
      setTimeout(() => (button.style.animation = ""), 600);
    }
  }

  function shareListing() {
    const url = window.location.href;
    const title = document.querySelector(".listing-main-title").textContent;

    if (navigator.share) {
      navigator.share({
        title: title,
        url: url,
      });
    } else {
      navigator.clipboard.writeText(url).then(() => {
        showNotification("Link copied to clipboard!", "success");
      });
    }
  }

  function viewFullscreen() {
    const img = document.querySelector(".listing-main-image");
    if (img.requestFullscreen) {
      img.requestFullscreen();
    } else if (img.webkitRequestFullscreen) {
      img.webkitRequestFullscreen();
    }
  }

  function confirmDelete(button) {
    if (
      confirm(
        "Are you sure you want to delete this listing? This action cannot be undone."
      )
    ) {
      const form = button.closest("form");

      button.classList.add("loading");
      button.disabled = true;

      setTimeout(() => {
        form.submit();
      }, 1000);
    }
  }

  function confirmReviewDelete(button) {
    if (confirm("Are you sure you want to delete this review?")) {
      const form = button.closest("form");

      button.classList.add("loading");
      button.disabled = true;

      setTimeout(() => {
        form.submit();
      }, 500);
    }
  }

  function showNotification(message, type = "success") {
    const existing = document.querySelector(".notification-toast");
    if (existing) existing.remove();

    const notification = document.createElement("div");
    notification.className = `notification-toast ${type}`;

    const iconClass =
      type === "success"
        ? "fa-check-circle"
        : type === "error"
        ? "fa-exclamation-circle"
        : "fa-info-circle";

    notification.innerHTML = `
      <div class="toast-icon ${type}">
        <i class="fas ${iconClass}"></i>
      </div>
      <div class="toast-message">${message}</div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add("show"), 100);

    setTimeout(() => {
      notification.classList.remove("show");
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Enhanced form submission
  document.querySelectorAll("form").forEach((form) => {
    form.addEventListener("submit", function (e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.classList.contains("loading")) {
        submitBtn.classList.add("loading");
        submitBtn.disabled = true;
      }
    });
  });
</script>

<!-- Notification Toast Styles -->
<style>
  .notification-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    border-left: 4px solid;
    z-index: 10000;
    transform: translateX(400px);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 280px;
  }

  .notification-toast.show {
    transform: translateX(0);
  }

  .notification-toast.success {
    border-left-color: #10b981;
  }

  .notification-toast.error {
    border-left-color: #ef4444;
  }

  .notification-toast.info {
    border-left-color: #3b82f6;
  }

  .toast-icon {
    font-size: 1.25rem;
  }

  .toast-icon.success {
    color: #10b981;
  }

  .toast-icon.error {
    color: #ef4444;
  }

  .toast-icon.info {
    color: #3b82f6;
  }

  .toast-message {
    font-weight: 600;
    color: #374151;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script src="/js/map.js"></script>
